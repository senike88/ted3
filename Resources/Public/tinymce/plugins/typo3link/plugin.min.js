
var plugin = tinymce.PluginManager.add('typo3link', function (editor, url) {

    var openLinkDialog = function () {
        var selectedElement = editor.selection.getNode();
        var element = editor.dom.getParent(selectedElement, 'a[href]');

        var currentLink = {
            url: "",
            target: "",
            title: ""
        }

        if (element) {
            currentLink.url = element.getAttribute('href');
            currentLink.target = element.target;
            currentLink.title = element.title;
        }


        var link = {};

        Ted3.jQuery("<div id='ted3-linkdialog'><span>Link:</span><input style='width:300px'  name='linkinput'  placeholder='Link/T3-Pid'  type='text' value='" + currentLink.url + "'/><br><span>Target:</span><input name='targetinput' placeholder='zB.: _blank' type='text' value='" + currentLink.target + "'/><br><span>Title:</span><input name='titleinput' type='text' value='" + currentLink.title + "'/></div>").dialog({
            appendTo: "#ted3-jqueryui",
            title: "Set Link",
            minWidth: 450,
            close: function () {
                Ted3.jQuery('#ted3-linkdialog').remove();
            },
            dialogClass: "ted3-dialog ted3-dialog-delete",
            position: {my: "center center", at: "center center"},
            buttons: {
                "Set Link": function () {

                    var that = Ted3.jQuery(this);
//                            alert();
                    link.url = Ted3.jQuery('#ted3-linkdialog').find('input[name="linkinput"]').val();

                    if (isNaN(link.url)) {
                         var splittedLink = link.url.split("#");
                         if(splittedLink.length > 1 && ! isNaN(splittedLink[0])){ // Fix Anchors
                             link.url = "t3://page?uid=" + splittedLink[0]+"#"+splittedLink[1];
                         }
                    } else {
                        link.url = "t3://page?uid=" + link.url;
                    }

                    plugin.createLink(
                            link.url,
                            Ted3.jQuery('#ted3-linkdialog').find('input[name="targetinput"]').val(),
                            "",
                            Ted3.jQuery('#ted3-linkdialog').find('input[name="titleinput"]').val()
                            );


                    that.dialog("close");



                },
                Cancel: function () {
                    Ted3.jQuery(this).dialog("close");

                }

            }
        });

    };

    // add the buttons
    editor.addButton('typo3link', {
        title: 'TYPO3 Link',
        icon: 'link',
        shortcut: 'Ctrl+K',
        onclick: openLinkDialog,
        stateSelector: 'a[href]'
    });

    editor.addButton('unlink', {
        title: 'Unlink',
        icon: 'unlink',
        shortcut: 'Ctrl+M',
        cmd: 'unlink',
        stateSelector: 'a[href]'
    });


    // add the menu entries
    editor.addMenuItem('unlink', {
        text: 'Unlink',
        context: 'insert',
        prependToContext: true,
        shortcut: 'Ctrl+M',
        icon: 'unlink',
        cmd: 'unlink',
        stateSelector: 'a[href]'
    });

    editor.addMenuItem('typo3link', {
        text: 'TYPO3 Link',
        context: 'insert',
        prependToContext: true,
        shortcut: 'Ctrl+K',
        icon: 'link',
        onclick: openLinkDialog,
        stateSelector: 'a[href]'
    });


    // initialize the shortcuts
    editor.addShortcut('Ctrl+K', '', openLinkDialog);
    editor.addShortcut('Ctrl+M', '', 'unlink');
    //editor.addShortcut('Ctrl+L', '', openImageDialog);
});

/**
 * Renders a link
 *
 * @param {string} href
 * @param {string} target
 * @param {string} cssClass
 * @param {string} title
 * @param {object} additionalValues currently unused
 * @return {void}
 */
plugin.createLink = function (href, target, cssClass, title, additionalValues) {
    var linkAttrs = {
        href: href,
        target: target ? target : null,
        class: cssClass ? cssClass : null,
        title: title ? title : null,
        'data-htmlarea-external': null
    };

//    for (var index in additionalValues) {
//        if (additionalValues.hasOwnProperty(index)) {
//            linkAttrs[index] = additionalValues[index];
//        }
//    }
    //linkAttrs.href = "/karr/test/";
    //alert(linkAttrs.href);
    var selectedElement = tinymce.activeEditor.selection.getNode();
    var element = tinymce.activeEditor.dom.getParent(selectedElement, 'a[href]');
    // alert(element);
    tinymce.activeEditor.focus();
    if (element) {
        //  alert("update");
        //  alert(linkAttrs.href);
        tinymce.activeEditor.dom.setAttribs(element, linkAttrs);
    } else {
//        alert("insert");
//        alert(element);
//        alert(linkAttrs.href);
        tinymce.activeEditor.execCommand('mceInsertLink', false, linkAttrs);
    }
    //tinymce.activeEditor.selection.collapse();
    tinymce.activeEditor.undoManager.add();

    //   tinymce.activeEditor.windowManager.getWindows()[0].close();
};

/**
 * Unlinks the current selection
 *
 * @return {void}
 */
plugin.unLink = function () {
    tinymce.activeEditor.execCommand('unlink');
    tinymce.activeEditor.windowManager.getWindows()[0].close();
};


/**
 * Just returns null
 *
 * @returns {null}
 */
plugin.getButton = function () {
    return null;
};

/**
 * Closes the current open dialog
 *
 * @return {void}
 */
plugin.close = function () {
    tinymce.activeEditor.windowManager.getWindows()[0].close();
};